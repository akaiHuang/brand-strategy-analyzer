# 結案報告（MarketSense v1.0 + Copilot SDK 擴展）

---

## 一、完成項目（功能面）
- **抓取/分析解耦流程**：Playwright 抓取 → Gzip 壓縮 → Storage/本機 → Trafilatura 清洗 → LLM 分析 → Firestore 存儲
- **本機 Raw HTML 優先模式**：支援「先下載、後多次分析」  
  - 參數：`LOCAL_RAW_DIR`, `LOCAL_STORE_ONLY`
- **任務佇列與鎖**：Firestore pending/running/analyzed/error 狀態 + 租約鎖（避免重複抓）
- **合規與風險**：robots.txt + allow/deny domain
- **自動節流**：站點級延遲（被擋降速）
- **維護任務**：回收鎖、重新排程、錯誤回補
- **品質回測與第二級優化**：LLM 回測品質並產生優化策略（寫回 Firestore）
- **報表/儀表板**：封鎖率、延遲、品質分數等統計
- **LLM Brief 互動/全自動**：品牌/產品輸入 → 互動提問 → 報告產出
- **url.txt 生成（真實搜尋）**：可使用 SerpAPI 搜尋實際網址 → 驗證 → 存 Firebase

---

## 二、主要程式碼與檔案
### MarketSense 核心模組（Python）
- `python/marketsense/config.py`  
- `python/marketsense/crawler.py`  
- `python/marketsense/analyzer.py`  
- `python/marketsense/task_queue.py`  
- `python/marketsense/quality_review.py`  
- `python/marketsense/briefing.py`  
- `python/marketsense/url_planner.py`  
- `python/marketsense/url_search.py`  
- `python/marketsense/url_validator.py`  
- `python/marketsense/reporting.py`

### CLI 命令入口
- `python/marketsense/main_crawler.py`
- `python/marketsense/main_analyzer.py`
- `python/marketsense/run_pipeline.py`
- `python/marketsense/main_quality_review.py`
- `python/marketsense/main_brief.py`
- `python/marketsense/main_url_planner.py`
- `python/marketsense/main_maintenance.py`
- `python/marketsense/main_report.py`
- `python/marketsense/main_dashboard.py`

### Firestore Collections
- `crawling_tasks`
- `marketing_briefs`
- `url_plans`

---

## 三、Copilot SDK 使用方式（已落地）
### 1) 多代理協作範例
- `examples/multi-agent-workflow.ts`  
  - 監工 / 開發 / 測試 代理  
- `examples/parallel-development.ts`  
  - 多會話並行開發  
- `examples/marketing-intel-orchestrator.ts`  
  - 行銷情報多代理自動輸出策略/資料規劃  

### 2) 執行指令
- `npm run marketing:intel -- --brief "品牌: X, 產品: Y, 目標: Z"`

---

## 四、測試狀況
### ✅ Pytest
已完整執行：
```
PYTHONPATH=python python3 -m pytest python/marketsense/tests
```
結果：**17 passed**  
- 覆蓋：解析、報表、brief、url planner、品質回測、本機 raw 讀取等

### ✅ 試跑狀況（本次）
已完成一次 dry-run 試跑：
- Crawler：3/3 成功  
- Analyzer：3 筆完成  
- Quality Review：3 筆完成  
- 本機 raw HTML 成功保存  
- Firestore maintenance query 需建立索引（下方說明）

---

## 五、目前注意事項 / 待調整點
1) **Firestore 索引**  
   - `running + locked_until`  
   - `error + failed_at`  
   → 需在 Firebase Console 建立 composite index  
   → 已做「不中斷」fallback

2) **Blocked suspected: 1**  
   - 建議降低 `MAX_CONCURRENT`、拉高 `MIN_DELAY/MAX_DELAY`
   - 或把該站加入 `DENY_DOMAINS`

3) **Playwright 依賴**  
   - 已安裝，但若更新需重新執行 `playwright install`

---

## 五-A、反爬蟲偵測防護（新增 2026-01-25）

### 已實作的人類行為模擬模組
| 功能 | 檔案 | 說明 |
|------|------|------|
| 人類行為模擬 | `human_behavior.py` | 滑鼠移動、捲動、閱讀停頓 |
| 動態 User-Agent | `human_behavior.py` | 10+ 種真實瀏覽器指紋輪換 |
| WebGL 偽裝 | `human_behavior.py` | 隱藏 Headless 特徵 |
| Dcard 專用爬蟲 | `dcard_crawler.py` | 使用已認證 session |

### 反偵測技術清單
```
✅ playwright-stealth         - 基礎反偵測
✅ 動態 User-Agent 輪換        - 避免指紋鎖定
✅ 隨機視窗大小               - 模擬真實螢幕
✅ WebGL Vendor/Renderer 偽裝  - 隱藏 SwiftShader
✅ 滑鼠軌跡模擬               - 貝茲曲線移動
✅ 捲動行為模擬               - 不規則捲動
✅ 閱讀停頓                   - 0.5-5 秒隨機
✅ 站點級自適應節流            - 被擋自動降速
✅ 認證狀態持久化             - Cookie + LocalStorage
```

### 建議的 .env 設定（降低封鎖率）
```bash
MAX_CONCURRENT=2          # 降低並行數
MIN_DELAY=3               # 增加最小延遲
MAX_DELAY=8               # 增加最大延遲  
DOMAIN_DELAY_BASE=2.0     # 站點基礎延遲
DOMAIN_DELAY_MAX=30.0     # 站點最大延遲
USER_AGENT=               # 留空啟用動態輪換
```

### IP 被標記的處理建議
1. **使用 VPN/Proxy 輪換 IP**
2. **降低爬取頻率** (已在 .env 調整)
3. **使用已登入的 session** (已建立 dcard-auth.json)
4. **避開尖峰時段** (凌晨 2-6 點較安全)

---

## 六、目前可用的正式流程
**建議流程（含 LLM Brief + url.txt + 分析）**
1) `main_brief`（互動/自動）
2) `main_url_planner`（真實搜尋 + url.txt）
3) `run_pipeline`（本機下載 + LLM 回測 + 二級優化）

---

## 七、結論
系統已完成「**品牌輸入 → LLM 分析 → url.txt 產生 → 爬蟲下載 → 分析 → 品質回測 → 優化 → Firebase 存儲**」的全流程，並具備擴展性，可直接套用到其他品牌。

---

如需補充：
- 架構流程圖 / 部署說明 / 品牌複用 SOP

請告知即可新增。
